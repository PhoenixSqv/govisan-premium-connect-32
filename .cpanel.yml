---
deployment:
  tasks:
    - export REPO_DIR=/home/govisanc/repositories/govisan
    - export PUBLIC_DIR=/home/govisanc/public_html

    # Activa el entorno Node.js creado en cPanel
    - source /home/govisanc/nodevenv/node-builder/20/bin/activate

    - cd $REPO_DIR
    - git reset --hard
    - git clean -fd
    - git pull origin main

    # Instalar dependencias y compilar
    - if [ -f package-lock.json ]; then npm ci || npm install; else npm install; fi
    - npm run build

    # Salir del virtualenv (por si acaso)
    - deactivate || true

    # Copiar el build al public_html
    - /bin/rsync -av --delete $REPO_DIR/dist/ $PUBLIC_DIR/

    # Crear .htaccess para SPA (si no existe)
    - if [ ! -f $PUBLIC_DIR/.htaccess ]; then echo "Options -MultiViews
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]" > $PUBLIC_DIR/.htaccess; fi
